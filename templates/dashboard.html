{% extends "base.html" %}

{% block title %}Orders Dashboard - Trackify{% endblock %}

{% block body %}
<div class="container py-4 fade-in">
  <h1 class="mb-4 text-center">📊 Orders Dashboard</h1>

  <!-- Filters & Sorting -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form class="row g-3" id="filtersForm" onsubmit="applyFilters(event)">
        <div class="col-md-3">
          <label for="customerFilter" class="form-label">Customer</label>
          <input type="text" id="customerFilter" class="form-control" placeholder="🔎 Search by customer">
        </div>

        <div class="col-md-2">
          <label for="statusFilter" class="form-label">Status</label>
          <select id="statusFilter" class="form-select">
            <option value="">All</option>
            <option value="Pending">⏳ Pending</option>
            <option value="Processing">⚙️ Processing</option>
            <option value="Shipped">📦 Shipped</option>
            <option value="Delivered">✅ Delivered</option>
          </select>
        </div>

        <div class="col-md-2">
          <label for="sortBy" class="form-label">Sort By</label>
          <select id="sortBy" class="form-select">
            <option value="">Default</option>
            <option value="customerAsc">Customer A → Z</option>
            <option value="customerDesc">Customer Z → A</option>
            <option value="dateNew">Date (Newest)</option>
            <option value="dateOld">Date (Oldest)</option>
          </select>
        </div>

        <div class="col-md-2">
          <label for="startDate" class="form-label">From</label>
          <input type="date" id="startDate" class="form-control">
        </div>

        <div class="col-md-2">
          <label for="endDate" class="form-label">To</label>
          <input type="date" id="endDate" class="form-control">
        </div>

        <div class="col-md-1 d-flex align-items-end">
          <button class="btn btn-primary w-100" type="submit" title="Apply filters">
            <i class="bi bi-funnel"></i>
          </button>
        </div>
      </form>
      <div class="mt-2 text-end">
        <button class="btn btn-outline-secondary btn-sm" onclick="resetFilters()">Reset</button>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="mb-3 text-center">
    <button class="btn btn-primary btn-sm me-2" onclick="getOrders()">📋 GET Orders</button>
    <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal" data-bs-target="#createModal">➕ POST Order</button>
    <button class="btn btn-warning btn-sm me-2" data-bs-toggle="modal" data-bs-target="#updateModal">✏️ PUT Order</button>
    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">🗑️ DELETE Order</button>
  </div>

  <!-- Orders Table -->
  <div class="table-responsive mb-4">
    <table class="table table-bordered table-striped align-middle shadow-sm" id="ordersTable" style="display: none;">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Customer</th>
          <th>Product</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
  </div>

  <!-- Analytics Controls -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-8">
          <label class="form-label fw-semibold">Select analytics to generate</label>
          <div class="d-flex gap-3 flex-wrap">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="analyticsStatus" checked>
              <label class="form-check-label" for="analyticsStatus">Status distribution</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="analyticsTime" checked>
              <label class="form-check-label" for="analyticsTime">Orders over time</label>
            </div>
            <!-- Changed checkbox id+label to Top Products (only this change) -->
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="analyticsProducts" checked>
              <label class="form-check-label" for="analyticsProducts">Top products</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="analyticsShowTable">
              <label class="form-check-label" for="analyticsShowTable">Also refresh table</label>
            </div>
          </div>
        </div>

        <div class="col-md-4 text-end">
          <label class="form-label opacity-0">Generate</label>
          <div>
            <button class="btn btn-primary" onclick="generateAnalytics()">
              <i class="bi bi-bar-chart"></i> Generate Analytics
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Section (initially hidden until generation) -->
  <div id="analyticsArea" class="mb-4" style="display:none;">
    <h3 class="text-center mb-3">📈 Analytics</h3>
    <div class="row g-4" id="analyticsRow">
      <!-- Cards will be shown based on options -->
      <div class="col-md-6" id="statusCard" style="display:none;">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">Orders by Status</div>
          <div class="card-body">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>

      <div class="col-md-6" id="timeCard" style="display:none;">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white">Orders Over Time</div>
          <div class="card-body">
            <canvas id="timeChart"></canvas>
          </div>
        </div>
      </div>

      <!-- REPLACED Top Customers with Top Products -->
      <div class="col-md-12" id="productCard" style="display:none;">
        <div class="card shadow-sm">
          <div class="card-header bg-warning">Top Products</div>
          <div class="card-body">
            <canvas id="productChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>

<!-- POST Modal -->
<div class="modal fade" id="createModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content border-success" onsubmit="createOrder(event)">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">➕ Create Order</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control mb-2" id="newCustomer" placeholder="Customer" required>
        <input type="text" class="form-control mb-2" id="newProduct" placeholder="Product" required>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Create</button>
      </div>
    </form>
  </div>
</div>

<!-- PUT Modal -->
<div class="modal fade" id="updateModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content border-warning" onsubmit="updateOrder(event)">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">✏️ Update Order Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="number" class="form-control mb-3" id="updateId" placeholder="Order ID" required>
        <label for="updateStatus" class="form-label">New Status</label>
        <select class="form-select" id="updateStatus" required>
          <option value="">-- Select Status --</option>
          <option value="Processing">⚙️ Processing</option>
          <option value="Shipped">📦 Shipped</option>
          <option value="Delivered">✅ Delivered</option>
        </select>
        <div class="form-text mt-2">
          Status flow: <b>⏳ Pending → ⚙️ Processing → 📦 Shipped → ✅ Delivered</b>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-warning text-dark">Update</button>
      </div>
    </form>
  </div>
</div>

<!-- DELETE Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content border-danger" onsubmit="deleteOrder(event)">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">🗑️ Delete Order</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="number" class="form-control mb-2" id="deleteId" placeholder="Order ID" required>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-danger">Delete</button>
      </div>
    </form>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const jwtToken = "{{ token }}";
  if (jwtToken) localStorage.setItem("jwtToken", jwtToken);

  // ---------------- Toast helper ----------------
  function showToast(message, type = "info") {
    const colors = {
      success: "bg-success text-white",
      error: "bg-danger text-white",
      warning: "bg-warning text-dark",
      info: "bg-primary text-white"
    };
    const toast = document.createElement("div");
    toast.className = `toast align-items-center ${colors[type]} border-0`;
    toast.role = "alert";
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    document.querySelector(".toast-container").appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    toast.addEventListener("hidden.bs.toast", () => toast.remove());
  }

  // ---------------- Utility Helpers ----------------
  function buildQueryParams() {
    const customer = document.getElementById("customerFilter").value.trim();
    const status = document.getElementById("statusFilter").value;
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const params = new URLSearchParams();
    if (customer) params.append("customer", customer);
    if (status) params.append("status", status);
    if (startDate) params.append("start_date", startDate);
    if (endDate) params.append("end_date", endDate);
    return params.toString();
  }

  function getStatusBadge(status) {
    switch (status) {
      case "Pending": return `<span class="badge bg-secondary">⏳ Pending</span>`;
      case "Processing": return `<span class="badge bg-warning text-dark">⚙️ Processing</span>`;
      case "Shipped": return `<span class="badge bg-info text-dark">📦 Shipped</span>`;
      case "Delivered": return `<span class="badge bg-success">✅ Delivered</span>`;
      default: return status;
    }
  }

  // parse "dd-mm-yyyy HH:MM:SS" into JS Date reliably
  function parseOrderDate(s) {
    if (!s) return new Date(0);
    // s expected like "31-08-2025 14:05:02"
    const [datePart, timePart] = s.split(" ");
    const [dd, mm, yyyy] = datePart.split("-").map(x => parseInt(x, 10));
    let hh = 0, min = 0, sec = 0;
    if (timePart) {
      [hh, min, sec] = timePart.split(":").map(x => parseInt(x, 10));
    }
    return new Date(yyyy, mm - 1, dd, hh || 0, min || 0, sec || 0);
  }

  function sortOrders(orders) {
    const sortBy = document.getElementById("sortBy").value;
    if (sortBy === "customerAsc") {
      return orders.sort((a, b) => a.customer.localeCompare(b.customer));
    }
    if (sortBy === "customerDesc") {
      return orders.sort((a, b) => b.customer.localeCompare(a.customer));
    }
    if (sortBy === "dateNew") {
      return orders.sort((a, b) => parseOrderDate(b.date) - parseOrderDate(a.date));
    }
    if (sortBy === "dateOld") {
      return orders.sort((a, b) => parseOrderDate(a.date) - parseOrderDate(b.date));
    }
    return orders;
  }

  // ---------------- Table / CRUD ----------------
  async function getOrders() {
    const token = localStorage.getItem("jwtToken");
    const qs = buildQueryParams();
    const url = qs ? `/orders?${qs}` : "/orders";
    const res = await fetch(url, {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();

    const table = document.getElementById("ordersTable");
    const body = document.getElementById("ordersBody");
    body.innerHTML = "";

    if (Array.isArray(data) && data.length) {
      const sorted = sortOrders(data);
      sorted.forEach(order => {
        body.innerHTML += `
          <tr>
            <td>${order.id}</td>
            <td>${order.customer}</td>
            <td>${order.product}</td>
            <td>${getStatusBadge(order.status)}</td>
            <td>${order.date}</td>
          </tr>
        `;
      });
      table.style.display = "table";
    } else {
      table.style.display = "table";
      body.innerHTML = `
        <tr><td colspan="5" class="text-center text-muted">No orders found for the selected filters.</td></tr>
      `;
    }

    return data || [];
  }

  function applyFilters(e) {
    e.preventDefault();
    getOrders();
  }

  function resetFilters() {
    document.getElementById("filtersForm").reset();
    getOrders();
  }

  // safe modal hide helper (creates instance if needed)
  function closeModalById(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const inst = bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el);
    inst.hide();
  }

  async function createOrder(e) {
    e.preventDefault();
    const token = localStorage.getItem("jwtToken");
    const customer = document.getElementById("newCustomer").value.trim();
    const product = document.getElementById("newProduct").value.trim();

    const res = await fetch("/orders", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify({ customer, product })
    });

    const data = await res.json();
    if (res.ok) {
      showToast("✅ Order created successfully", "success");
      closeModalById("createModal");
      // clear fields
      document.getElementById("newCustomer").value = "";
      document.getElementById("newProduct").value = "";
    } else {
      showToast(data.error || "Failed to create order", "error");
    }

    // Refresh table and optionally analytics if visible
    const orders = await getOrders();
    if (document.getElementById("analyticsArea").style.display !== "none") {
      // regenerate charts with current options
      renderSelectedCharts(orders);
    }
  }

  async function updateOrder(e) {
    e.preventDefault();
    const token = localStorage.getItem("jwtToken");
    const id = document.getElementById("updateId").value.trim();
    const status = document.getElementById("updateStatus").value;

    const res = await fetch(`/orders/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify({ status })
    });

    const data = await res.json();
    if (res.ok) {
      showToast("⚙️ Order updated successfully", "warning");
      closeModalById("updateModal");
      document.getElementById("updateId").value = "";
      document.getElementById("updateStatus").value = "";
    } else {
      showToast(data.error || "Failed to update order", "error");
    }

    const orders = await getOrders();
    if (document.getElementById("analyticsArea").style.display !== "none") {
      renderSelectedCharts(orders);
    }
  }

  async function deleteOrder(e) {
    e.preventDefault();
    const token = localStorage.getItem("jwtToken");
    const id = document.getElementById("deleteId").value.trim();

    const res = await fetch(`/orders/${id}`, {
      method: "DELETE",
      headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();
    if (res.ok) {
      showToast("🗑️ Order deleted successfully", "success");
      closeModalById("deleteModal");
      document.getElementById("deleteId").value = "";
    } else {
      showToast(data.error || "Failed to delete order", "error");
    }

    const orders = await getOrders();
    if (document.getElementById("analyticsArea").style.display !== "none") {
      renderSelectedCharts(orders);
    }
  }

  // ---------------- Analytics (Chart.js) ----------------
  let statusChart = null, timeChart = null, productChart = null;

  function destroyCharts() {
    if (statusChart) { statusChart.destroy(); statusChart = null; }
    if (timeChart) { timeChart.destroy(); timeChart = null; }
    if (productChart) { productChart.destroy(); productChart = null; }
  }

  function renderStatusChart(orders) {
    const counts = {};
    orders.forEach(o => counts[o.status] = (counts[o.status] || 0) + 1);
    const labels = Object.keys(counts);
    const data = Object.values(counts);
    const bg = labels.map(l => {
      if (l === "Pending") return "#6c757d";
      if (l === "Processing") return "#ffc107";
      if (l === "Shipped") return "#0dcaf0";
      if (l === "Delivered") return "#198754";
      return "#adb5bd";
    });

    const ctx = document.getElementById("statusChart").getContext("2d");
    statusChart = new Chart(ctx, {
      type: "pie",
      data: { labels, datasets: [{ data, backgroundColor: bg }] }
    });
  }

  function renderTimeChart(orders) {
    // group by date (dd-mm-yyyy)
    const counts = {};
    orders.forEach(o => {
      // date is "dd-mm-yyyy HH:MM:SS" -> take dd-mm-yyyy
      const dateOnly = o.date ? o.date.split(" ")[0] : "Unknown";
      counts[dateOnly] = (counts[dateOnly] || 0) + 1;
    });

    // sort by actual date
    const entries = Object.entries(counts).sort((a, b) => {
      const da = parseOrderDate(a[0] + " 00:00:00");
      const db = parseOrderDate(b[0] + " 00:00:00");
      return da - db;
    });

    const labels = entries.map(e => e[0]);
    const data = entries.map(e => e[1]);

    const ctx = document.getElementById("timeChart").getContext("2d");
    timeChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Orders",
          data,
          borderColor: "#0d6efd",
          backgroundColor: "rgba(13,110,253,0.15)",
          fill: true,
          tension: 0.25
        }]
      },
      options: { scales: { y: { beginAtZero: true, ticks: {precision:0} } } }
    });
  }

  // NEW: renderProductChart (replaces previous customer chart)
  function renderProductChart(orders) {
    const counts = {};
    orders.forEach(o => counts[o.product] = (counts[o.product] || 0) + 1);
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 8); // top 8 products
    const labels = sorted.map(s => s[0]);
    const data = sorted.map(s => s[1]);

    // visually pleasing color palette
    const colors = ["#ff6384","#36a2eb","#ffcd56","#4bc0c0","#9966ff","#ff9f40","#c9cbcf","#2ecc71"];
    const bg = colors.slice(0, labels.length);

    const ctx = document.getElementById("productChart").getContext("2d");
    productChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Orders per Product",
          data,
          backgroundColor: bg,
          borderRadius: 6,
          barThickness: 28
        }]
      },
      options: {
        plugins: {
          tooltip: { enabled: true, mode: 'nearest' },
          legend: { display: false },
          title: { display: true, text: 'Top Products by Order Count', font: { size: 16 } }
        },
        scales: {
          x: { title: { display: true, text: "Products" } },
          y: { beginAtZero: true, title: { display: true, text: "Orders" }, ticks: { precision: 0 } }
        }
      }
    });
  }

  // Render only selected charts
  function renderSelectedCharts(orders) {
    destroyCharts();

    const showStatus = document.getElementById("analyticsStatus").checked;
    const showTime = document.getElementById("analyticsTime").checked;
    const showProducts = document.getElementById("analyticsProducts").checked;

    document.getElementById("analyticsArea").style.display = (showStatus || showTime || showProducts) ? "block" : "none";

    document.getElementById("statusCard").style.display = showStatus ? "block" : "none";
    document.getElementById("timeCard").style.display = showTime ? "block" : "none";
    document.getElementById("productCard").style.display = showProducts ? "block" : "none";

    if (showStatus) renderStatusChart(orders);
    if (showTime) renderTimeChart(orders);
    if (showProducts) renderProductChart(orders);
  }

  // Called when user clicks "Generate Analytics"
  async function generateAnalytics() {
    // optionally refresh table first if requested
    const refreshTable = document.getElementById("analyticsShowTable").checked;
    const orders = await getOrders(); // respects filters & returns data array

    if (!orders || !orders.length) {
      showToast("No data available for analytics with current filters", "info");
      // still hide charts area
      document.getElementById("analyticsArea").style.display = "none";
      destroyCharts();
      return;
    }

    renderSelectedCharts(orders);

    if (!refreshTable) {
      // if user opted not to refresh table, restore original table content from last fetch
      // (getOrders already updated table; this is a noop)
    }
    showToast("📊 Analytics generated", "info");
  }

  // initial load
  document.addEventListener("DOMContentLoaded", () => {
    getOrders();
    // analytics hidden until user generates
    document.getElementById("analyticsArea").style.display = "none";
  });
</script>
{% endblock %}
